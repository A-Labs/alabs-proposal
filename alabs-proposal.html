<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../neon-animation/neon-animated-pages.html">
<link rel="import" href="../neon-animation/neon-animation.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../locals-button/locals-button.html">
<link rel="import" href="../locals-item/locals-item.html">
<link rel="import" href="../locals-style/locals-style.html">
<link rel="import" href="../locals-confirm/locals-confirm.html">
<link rel="import" href="../locals-input/locals-input.html">
<link rel="import" href="../locals-textarea/locals-textarea.html">
<link rel="import" href="../ipfs-upload/ipfs-upload.html">
<link rel="import" href="../firebase-element/firebase.html">
<link rel="import" href="../alabs-datetime/alabs-datetime.html">
<link rel="import" href="../locals-contractlistener/locals-contractlistener.html">
<script src="../pikaday/pikaday.js"></script>
<script src="../moment/min/moment-with-locales.min.js"></script>

<!--
This renders a proposal, getting it's JSON data from IPFS / Firebase / Ethereum contract.

Example:

    <alabs-proposal ipfshash="the_ipfshash" edit></alabs-proposal>

@group Seed Elements
@element alabs-proposal
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="alabs-proposal">

  <template>
    <style>
      :host {
        display: block;
      }

     .whitespace {
      height: 20px;
     }
      h1 {
      @apply(--opensans-light);
      -webkit-margin-before:7px;
      -webkit-margin-after:7px;
      -webkit-margin-start:0em;
      -webkit-margin-end:0em;
      margin: 7px 0px 7px 0px;
      padding: 0px;
      font-size: 40px;
      line-height: 52px;
/*       @apply(--locals-font-h1);*/
      }
      h2 {
       @apply(--locals-font-h2);
      }
      h3 {
       @apply(--locals-font-h3);
      }
      h4 {
       @apply(--locals-font-h4);
      }
      p {
       @apply(--locals-font-body1);
      }
      small {
       @apply(--locals-font-small);
       color: rgba(0,0,0,0.75);
      }

      .from p {
        font-size: 14px;

        color: var(--locals-grey3);
        @apply(--opensans-reg);
      }

      .confirmbtns {
        width: 100%;
        @apply(--layout-horizontal);
      }

      .confirmbtns locals-button {
        margin: 10px 10px 10px 0px;
      }

      .votebtns {
      }

      .votebtns locals-button {
        width: 250px;
        margin: 5px 0px 5px 0px;
      }

      .accent {
       @apply(--opensans-bold);
       text-decoration: underline;
      }

      .accent2 {
        @apply(--opensans-reg);
       text-decoration: underline;
      }


      .voted {
        max-width: 350px;
        box-sizing: border-box;
        padding: 25px;
        background-color:var(--locals-grey1);
      }

      .line {
        height: 2px;
        border-bottom: 1px dashed var(--locals-grey2);
      }


    </style>

    <template is="dom-if" if="{{edit}}">

<!--     <iron-pages selected="{{editselected}}"> -->
    <neon-animated-pages
      selected="{{editselected}}"
      entry-animation="{{entryAnimation}}"
      exit-animation="{{exitAnimation}}">

   <!--  What you see when you add a new proposal -->
    <neon-animatable>
      <h1>New proposal</h1>
<!--       <p>Your account: <span>{{account}}</span> balance: <span>{{balance}}</span></p>
 -->      <p>The current cost for a new proposal is <span>2</span> Δ.</p>
      <locals-textarea bind-value="{{description}}" label="Proposal description"></locals-textarea>
      <div class="whitespace"></div>
      <locals-input bind-value="{{budget}}" value="{{budget}}" label="Budget"></locals-input>
      <div class="whitespace"></div>
      <locals-textarea bind-value="{{beneficiary}}" label="Beneficiary"></locals-textarea>
      <div class="whitespace"></div>
      <locals-button txtcolor="green" on-tap="prevProposal">Preview</locals-button>
    </neon-animatable>

    <!-- What you see: preview before submitting proposal -->
    <neon-animatable>

      <h1>{{description}}</h1>
      <p><span>{{budget}}</span> Δ for <span>{{beneficiary}}</span></p>
      <div class="line"></div>
    <locals-confirm on-cancel="toProposal" on-confirm="saveProposal">You are posting this proposal.</locals-confirm>
    </neon-animatable>


    <!-- What you see: progress of proposal submission -->
    <neon-animatable>
      <div class="localstypo" id="log"></div>
    </neon-animatable>

    </neon-animated-pages>


    </template>

    <template is="dom-if" if="{{!edit}}">

    <neon-animated-pages
      selected="{{pageselected}}"
      entry-animation="{{entryAnimation}}"
      exit-animation="{{exitAnimation}}">
      
      <!-- What you see: non editable view of proposal, ready to vote on. -->
      <section>
      <h1>{{data.description}}</h1>
      <p>{{data.votingdeadline}}</p>
      <div class="from"><p><alabs-datetime timestamp="{{startdate}}" format="LLLL"></alabs-datetime></p>
      <p><span>{{data.amount}}</span> Δ for <span>{{data.recipient}}</span></p></div>
      <div class="whitespace"></div>

      <!-- If you haven't already voted, you'll see the voting buttons. -->
      <template is="dom-if" if="{{!voted}}">
      <div class="votebtns">
      <locals-button on-tap="voteno">Vote <span class="accent">against</span> this proposal</locals-button>
      <locals-button on-tap="voteyes">Vote <span class="accent">for</span> this proposal</locals-button>
      </div>
      </template>

      <!-- If you have already voted, you won't see the voting buttons. -->
      <template is="dom-if" if="{{voted}}">
        <div class="voted">    
        <p>You voted already on this proposal.</p>
        </div>
      </template>
    </section>

    <!-- What you see: a confirmation / preview before you vote. -->
    <section>
    <locals-confirm on-cancel="cancel" on-confirm="saveVote">You are about to vote <span class="accent2">{{currentvote}}</span> this proposal.</locals-confirm>
<!--       <div class="confirmbtns">
        <locals-button txtcolor="red" icon="decline" on-tap=""></locals-button>
        <locals-button txtcolor="green" icon="v" on-tap=""></locals-button>
      </div> -->


    </section>

    <!-- What you see: the progress of your vote submission -->
    <section>
      <h2>Vote progress:</h2>
      <locals-button red on-tap="cancel">Cancel</locals-button>
      <div id="log"></div>
    </section>

    </neon-animated-pages>

    </template>


  </template>
</dom-module>

<script>

  Polymer({

    is: 'alabs-proposal',

    properties: {

      /**
       * The IPFS hash, which can be resolved to a json object.
       * @type {{ipfshash: string}}
       */
      data: {
        type: Object,
        observer: '_data'
      },

      /**
       * The user's primary eth wallet account
       * @type {{account: string}}
       */
      account: {
        type: String
      },

      /**
       * Boolean, triggers edit / read mode
       * @type {{edit: boolean}}
       */
      edit: {
        type: Boolean,
        value: false
      },

      entryAnimation: {
        type: String,
        value:"slide-from-right-animation"
      },
      
      exitAnimation: {
        type: String,
        value:"slide-left-animation"
      },
      /**
       * Boolean, triggers already vote mode
       * @type {{voted: boolean}}
       */
      voted: {
        type: Boolean,
        value: false
      },

      /**
       * The author of the vote, an object with human readable name and eth address. 
       *
       * @type {{name: string, address: string}}
       */
      author: {
        type: String
      },

      /** The subject of the proposal
      * @type {{subject: string}}
      */
      subject: {
        type: String
      },


      /** The description of the proposal
      * @type {{description: string}}
      */
      description: {
        type: String
      },

      /** The start date of the proposal (unixtime)
      * @type {{startdate: number}}
      */
      startdate: {
        type: Number
      },

      /** The end date of the proposal (unixtime)
      * @type {{enddate: number}}
      */
      enddate: {
        type: Number
      },

      /** The deliverables of the proposal (array)
      * @type {{deliverables: Array}}
      */
      deliverables: {
        type: Array,
        value: []
      },

      /** The cost of creating a new proposal
      * @type {{cost: number}}
      */
      cost: {
        type: Number,
        value: 0
      },

      /** The budget you're asking for in the proposal
      * @type {{budget: number}}
      */
      budget: {
        type: Number,
        value: 0
      },

      /** Web3 object, used to sign the tx.
      * @type {{web3: object}}
      */
      web3: {
        type: Object,
        observer: '_web3observer'
      },

      /** IPFS object
      * @type {{ipfs: object}}
      */
      ipfs: {
        type: Object
      },

      /** The contract address where the proposals are stored.
      * @type {{contractaddr: string}}
      */
      contractaddr: {
        type: String,
        value: '0xffeC3944471F589ad5200e095B4B6032691f1797'
      },


      editselected: {
        type: Number,
        observer: '_editselected'
      },

      pageselected: {
        type: Number,
        observer: '_pageselected'
      },

      /** The contract application blockchain interface.
      * @type {{contractabi: object}}
      */
      contractabi: {
      type: Object,
      value: [{
        "constant": true,
        "inputs": [{
          "name": "",
          "type": "uint256"
        }],
        "name": "proposals",
        "outputs": [{
          "name": "recipient",
          "type": "address",
          "value": "0x9f376495fc3678a059db1e823af1e1c92ea8f385"
        }, {
          "name": "amount",
          "type": "uint256",
          "value": "1"
        }, {
          "name": "description",
          "type": "string",
          "value": "Schrijf een blogpost"
        }, {
          "name": "votingDeadline",
          "type": "uint256",
          "value": "1461667765"
        }, {
          "name": "executed",
          "type": "bool",
          "value": true
        }, {
          "name": "proposalPassed",
          "type": "bool",
          "value": true
        }, {
          "name": "numberOfVotes",
          "type": "uint256",
          "value": "1"
        }, {
          "name": "proposalHash",
          "type": "bytes32",
          "value": "0xbbb6a09ee5888a4878fc378b3bca63f4d92e595b3ef276d9d352719f2d5caa07"
        }],
        "type": "function"
      }, {
        "constant": false,
        "inputs": [{
          "name": "proposalNumber",
          "type": "uint256"
        }, {
          "name": "transactionBytecode",
          "type": "bytes"
        }],
        "name": "executeProposal",
        "outputs": [{
          "name": "result",
          "type": "int256"
        }],
        "type": "function"
      }, {
        "constant": true,
        "inputs": [],
        "name": "sharesTokenAddress",
        "outputs": [{
          "name": "",
          "type": "address",
          "value": "0x5bdb31fbbc4fed30db973d2d70537676c9d4dcb8"
        }],
        "type": "function"
      }, {
        "constant": true,
        "inputs": [],
        "name": "numProposals",
        "outputs": [{
          "name": "",
          "type": "uint256",
          "value": "6"
        }],
        "type": "function"
      }, {
        "constant": false,
        "inputs": [{
          "name": "sharesAddress",
          "type": "address"
        }, {
          "name": "minimumSharesToPassAVote",
          "type": "uint256"
        }, {
          "name": "minutesForDebate",
          "type": "uint256"
        }],
        "name": "changeVotingRules",
        "outputs": [],
        "type": "function"
      }, {
        "constant": true,
        "inputs": [],
        "name": "debatingPeriodInMinutes",
        "outputs": [{
          "name": "",
          "type": "uint256",
          "value": "10"
        }],
        "type": "function"
      }, {
        "constant": true,
        "inputs": [],
        "name": "minimumQuorum",
        "outputs": [{
          "name": "",
          "type": "uint256",
          "value": "1"
        }],
        "type": "function"
      }, {
        "constant": true,
        "inputs": [],
        "name": "owner",
        "outputs": [{
          "name": "",
          "type": "address",
          "value": "0x03f3be66f4dca6e7f5c15bd4950d78f66709ea44"
        }],
        "type": "function"
      }, {
        "constant": false,
        "inputs": [{
          "name": "beneficiary",
          "type": "address"
        }, {
          "name": "etherAmount",
          "type": "uint256"
        }, {
          "name": "JobDescription",
          "type": "string"
        }, {
          "name": "transactionBytecode",
          "type": "bytes"
        }],
        "name": "newProposal",
        "outputs": [{
          "name": "proposalID",
          "type": "uint256"
        }],
        "type": "function"
      }, {
        "constant": false,
        "inputs": [{
          "name": "proposalNumber",
          "type": "uint256"
        }, {
          "name": "supportsProposal",
          "type": "bool"
        }],
        "name": "vote",
        "outputs": [{
          "name": "voteID",
          "type": "uint256"
        }],
        "type": "function"
      }, {
        "constant": true,
        "inputs": [{
          "name": "proposalNumber",
          "type": "uint256"
        }, {
          "name": "beneficiary",
          "type": "address"
        }, {
          "name": "etherAmount",
          "type": "uint256"
        }, {
          "name": "transactionBytecode",
          "type": "bytes"
        }],
        "name": "checkProposalCode",
        "outputs": [{
          "name": "codeChecksOut",
          "type": "bool",
          "value": false
        }],
        "type": "function"
      }, {
        "constant": false,
        "inputs": [{
          "name": "newOwner",
          "type": "address"
        }],
        "name": "transferOwnership",
        "outputs": [],
        "type": "function"
      }, {
        "inputs": [{
          "name": "sharesAddress",
          "type": "address",
          "index": 0,
          "typeShort": "address",
          "bits": "",
          "displayName": "shares Address",
          "template": "elements_input_address",
          "value": "0x79FCA913Bb8c6Be97145aFd5A9B70300663AF1d7"
        }, {
          "name": "minimumSharesToPassAVote",
          "type": "uint256",
          "index": 1,
          "typeShort": "uint",
          "bits": "256",
          "displayName": "minimum Shares To Pass A Vote",
          "template": "elements_input_uint",
          "value": ""
        }, {
          "name": "minutesForDebate",
          "type": "uint256",
          "index": 2,
          "typeShort": "uint",
          "bits": "256",
          "displayName": "minutes For Debate",
          "template": "elements_input_uint",
          "value": "5"
        }],
        "type": "constructor"
      }, {
        "anonymous": false,
        "inputs": [{
          "indexed": false,
          "name": "proposalID",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "recipient",
          "type": "address"
        }, {
          "indexed": false,
          "name": "amount",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "description",
          "type": "string"
        }],
        "name": "ProposalAdded",
        "type": "event"
      }, {
        "anonymous": false,
        "inputs": [{
          "indexed": false,
          "name": "proposalID",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "position",
          "type": "bool"
        }, {
          "indexed": false,
          "name": "voter",
          "type": "address"
        }],
        "name": "Voted",
        "type": "event"
      }, {
        "anonymous": false,
        "inputs": [{
          "indexed": false,
          "name": "proposalID",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "result",
          "type": "int256"
        }, {
          "indexed": false,
          "name": "quorum",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "active",
          "type": "bool"
        }],
        "name": "ProposalTallied",
        "type": "event"
      }, {
        "anonymous": false,
        "inputs": [{
          "indexed": false,
          "name": "minimumQuorum",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "debatingPeriodInMinutes",
          "type": "uint256"
        }, {
          "indexed": false,
          "name": "sharesTokenAddress",
          "type": "address"
        }],
        "name": "ChangeOfRules",
        "type": "event"
      }]
    }

    },

    // Element Lifecycle

    ready: function() {
      this.editselected = 0;
      this.pageselected = 0;
      this.entryAnimation = "fade-in-animation";
      this.exitAnimation = "fade-out-animation";
      // `ready` is called after all elements have been configured, but
      // propagates bottom-up. This element's children are ready, but parents
      // are not.
      //
      // This is the point where you should make modifications to the DOM (when
      // necessary), or kick off any processes the element wants to perform.
    },

    attached: function() {
      this.editselected = 0;
      this.pageselected = 0;
      // `attached` fires once the element and its parents have been inserted
      // into a document.
      //
      // This is a good place to perform any work related to your element's
      // visual state or active behavior (measuring sizes, beginning animations,
      // loading resources, etc).
    },

    _web3observer: function() {
      console.log('alabs-propsal : loaded web3');
    },

    detached: function() {
      // The analog to `attached`, `detached` fires when the element has been
      // removed from a document.
      //
      // Use this to clean up anything you did in `attached`.
    },

    // Add 0x to address 
    fixaddress: function(address) {
      function strStartsWith(str, prefix) {
        return str.indexOf(prefix) === 0;
      }

      if (!strStartsWith(address, '0x')) {
        return ('0x' + address);
      }
      return address;
    },

    // Element Behavior

    /**
     * saveProposal: this saves the proposal on IPFS, Firebase, and stores the IPFS hash on Ethereum.
     */
    saveProposal: function() {
      this.editselected = 2;

      var self = this;

      var proposal = {};
      proposal.account = this.fixaddress(this.account);
      proposal.beneficiary = this.beneficiary;
      proposal.description = this.description;
      proposal.budget = this.budget;

      this.transactionlog('savingtoipfs');

      self.web3.eth.getGasPrice(function(err, result) {

        var MyContract = self.web3.eth.contract(self.contractabi);
        var myContractInstance = MyContract.at(self.contractaddr);

        var gasPrice = result.toNumber(10);

        self.transactionlog('gas price: ', gasPrice);

        var beneficiary = self.fixaddress(self.beneficiary);

        var account = self.fixaddress(self.account);

        var options = {
          from: account,
          //value: 1 * 1e18,
          gas: 200000,
          gasPrice: gasPrice,
          nonce: new Date().getTime(),
        };

        var result = myContractInstance.newProposal.sendTransaction(beneficiary, proposal.budget, proposal.description, null, options,
          function(err, result) {
            if (err != null) {
              console.log(err);
              console.log("ERROR: Transaction didn't go through. See console.");
              self.transactionlog('ERROR: Transaction didnt go through. See console.');
            } else {
              console.log("Transaction Successful!");
              self.transactionlog('Transaction success: ', result);
              console.log('Tx hash=',result);
              // set vote status to TxHash received 
              //self.votestatus = 2;
              self.transactionHash = result;
              self.transactionlog('Proposal has been added to the blockchain');
            }
          });
        });
    },

    _data: function(){
      //console.log(this.data);
      //var MyContract = self.web3.eth.contract(self.contractabi);
      //var myContractInstance = MyContract.at(self.contractaddr);
      //var voted = myContractInstance().toNumber();
    },

    /**
     * _calccost: this calculates the total of deliverables costs.
     */
    _calccost: function(){
      var cost = 0;
      for (var i = this.deliverables.length - 1; i >= 0; i--) {
        console.log(this.deliverables[i].budget);
        cost = cost + this.deliverables[i].budget;
      };
      this.cost = cost;
    },

    transactionlog: function(arg){
      var self = this;
      var log = document.getElementById("log");
      var item = document.createElement("p");
      item.innerHTML = arg;
      log.appendChild(item);
    },

    voteyes: function(){
      console.log('yes vote');
      this.pageselected = 1;
      this.supportsProposal = true;
      this.currentvote = "for";
    },

    voteno: function(){
      console.log('no vote');
      this.supportsProposal = false;
      this.currentvote = "against";
      this.pageselected = 1;
    },

    saveVote: function() {
      var self = this;
      self.web3.eth.getGasPrice(function(err, result) {

        var MyContract = self.web3.eth.contract(self.contractabi);
        var myContractInstance = MyContract.at(self.contractaddr);

        var gasPrice = result.toNumber(10);
        self.transactionlog('gas price: ', gasPrice);

        var options = {
          from: self.fixaddress(self.account),
          //value: 1 * 1e18,
          gas: 200000,
          gasPrice: gasPrice,
          nonce: new Date().getTime(),
        };

        self.transactionlog('Casting vote');
        self.pageselected = 2;

        var result = myContractInstance.vote.sendTransaction(self.data.index, self.supportsProposal, "tralala", options,
          function(err, result) {
            if (err != null) {
              console.log(err);
              self.transactionlog('ERROR: Transaction didnt go through. See console.');
            } else {
              self.transactionlog('Transaction success: ', result);
              console.log('Tx hash=', result);
              self.watchtransaction(result,function (err,res){
                console.log('TX',result,'viewed on BC');
              })
              self.transactionlog('Your vote has been added to the blockchain');
            }
          });
      });


    },

    watchtransaction: function(txhash,cb){

       var myfilter = document.createElement('locals-contractlistener');
        myfilter.web3 = this.web3;
        myfilter.filter = { topics : [txhash] };
        myfilter.addEventListener('filter-match',function(err,res){
//          myfilter.
          console.log('watchtransaction matched something..',err,res);
          cb(err,res);
        });       

    },

    cancel: function(){
      window.clearInterval();
      this.pageselected = 0;
      var log = document.getElementById("log");
      //log.removeChildren();
      while (log.hasChildNodes()) {
        log.removeChild(log.lastChild);
      };
    },

    prevProposal: function(){
      this.editselected = 1;
    },

    toProposal: function(){
      this.editselected = 0;
    },

    _editselected: function(){
      // console.log("editselected is=", this.editselected);
    },

    _pageselected: function(){
      console.log("pageselected is=", this.pageselected);
    },

  });

</script>

